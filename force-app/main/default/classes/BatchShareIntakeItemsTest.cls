@isTest
private class BatchShareIntakeItemsTest {
    @testSetup
    private static void setup(){
        Account acct = TestDiligenceUtils.getCharterHolder();
        insert acct;
        Intake_Item__c ii = TestDiligenceUtils.getOngoingDiligenceItem(acct);
        insert ii;
        Contact con = TestDiligenceUtils.getContact(acct);
        insert con;
        Community_Contact_Role__c ccr = TestDiligenceUtils.getCCR(con, acct);
        insert ccr;

        TestDiligenceUtils.getUser(con, true);

        delete [ SELECT Id FROM Intake_Item__Share WHERE RowCause = 'Manual' ]; // remove any shares that get generated by triggers
    }

    @isTest
    private static void testBatch() {
        Intake_Item__c ii = [ SELECT Id FROM Intake_Item__c ];
        Contact con = [ SELECT Id FROM Contact ];
        User u = [ SELECT Id FROM User WHERE ContactId = :con.Id ];

        System.assertEquals(0, [ SELECT COUNT() FROM Intake_Item__Share WHERE UserOrGroupId = :u.Id AND ParentId = :ii.Id AND RowCause = 'Manual' ]);

        Test.startTest();
        Database.executeBatch(new BatchShareIntakeItems());
        Test.stopTest();

        System.assertEquals(1, [ SELECT COUNT() FROM Intake_Item__Share WHERE UserOrGroupId = :u.Id AND ParentId = :ii.Id AND RowCause = 'Manual' ]);
    }
}